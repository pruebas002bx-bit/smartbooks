<script>
    (async function() {
        let SCHOOLS_DATA = [];
        let currentSchool = null;

        async function loadSchoolsFromDB() {
            try {
                const res = await fetch('/api/schools');
                if (!res.ok) throw new Error("Error fetching schools");
                SCHOOLS_DATA = await res.json();
                renderSchools();
            } catch(e) { console.error(e); }
        }

        const getEl = (id) => document.getElementById(id);
        const els = {
            schoolBtn: getEl('school-select-button'), schoolMenu: getEl('school-dropdown-menu'), schoolList: getEl('school-list'), schoolSearch: getEl('school-search-input'), schoolContainer: getEl('school-dropdown-container'),
            courseBtn: getEl('course-select-button'), courseMenu: getEl('course-dropdown-menu'), courseList: getEl('course-list'), courseContainer: getEl('course-dropdown-container'),
            labelGrade: getEl('label-grade'), badgeGradeNumber: getEl('badge-number-2'), badgeGradeStatus: getEl('badge-status-2'),
            card: getEl('package-card'), loading: getEl('search-loading'), initialState: getEl('initial-state'), addBtn: getEl('add-kit-btn'),
            cardColegio: getEl('card-colegio'), cardCity: getEl('card-city'), cardCurso: getEl('card-curso'), cardImagen: getEl('card-imagen'), cardKitName: getEl('card-kit-name'), packageDetails: getEl('package-details')
        };

        function renderSchools(filter = '') {
            if (!els.schoolList) return;
            els.schoolList.innerHTML = '';
            const filtered = SCHOOLS_DATA.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
            if(filtered.length === 0) { els.schoolList.innerHTML = '<div class="p-6 text-gray-400 text-center text-sm font-instrument">No encontramos coincidencias.</div>'; return; }
            
            filtered.forEach(school => {
                const div = document.createElement('div');
                div.className = 'p-3 md:p-4 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 flex justify-between items-center group transition-colors duration-200';
                // CORREGIDO: school.logo_url en lugar de school.img
                div.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><div class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-gray-50 border border-gray-200 p-1 flex items-center justify-center shrink-0"><img src="${school.logo_url}" class="w-full h-full object-contain"></div><span class="font-bold text-gray-700 group-hover:text-[#143c6c] font-outfit text-sm md:text-base truncate">${school.name}</span></div><span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-bold uppercase group-hover:bg-[#143c6c] group-hover:text-white transition tracking-wide shrink-0 ml-2">${school.city}</span>`;
                div.onclick = (e) => { e.stopPropagation(); selectSchool(school); };
                els.schoolList.appendChild(div);
            });
        }

        function selectSchool(school) {
            currentSchool = school;
            // CORREGIDO: school.logo_url
            els.schoolBtn.innerHTML = `<div class="flex items-center gap-2 md:gap-3 overflow-hidden"><img src="${school.logo_url}" class="w-6 h-6 object-contain shrink-0"><span class="font-bold text-[#143c6c] text-base md:text-lg truncate">${school.name}</span></div><div class="bg-green-100 text-green-600 rounded-full p-1 shadow-sm shrink-0"><i class="fas fa-check text-xs"></i></div>`;
            els.schoolBtn.className = "w-full bg-blue-50/50 border-2 border-[#143c6c] text-left py-4 px-4 md:py-5 md:px-6 rounded-xl md:rounded-2xl flex items-center justify-between shadow-md transition-all relative z-20";
            els.schoolMenu.classList.add('hidden');

            els.courseContainer.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
            els.courseBtn.innerHTML = `<span class="text-gray-600 font-bold text-base md:text-lg flex items-center gap-2 md:gap-3 truncate"><i class="fas fa-layer-group text-[#143c6c]"></i> <span class="truncate">Selecciona el Grado</span></span><div class="bg-[#143c6c] rounded-lg p-2 text-white shadow-lg hover:scale-110 transition-transform shrink-0"><i class="fas fa-chevron-down text-xs"></i></div>`;
            els.courseBtn.className = "w-full bg-white border-2 border-gray-200 text-left py-4 px-4 md:py-5 md:px-6 rounded-xl md:rounded-2xl flex items-center justify-between hover:border-[#143c6c] hover:shadow-lg transition-all duration-300 cursor-pointer group relative z-20";
            
            els.labelGrade.classList.remove('text-gray-400'); els.labelGrade.classList.add('text-[#143c6c]');
            els.badgeGradeNumber.classList.remove('bg-gray-200', 'text-gray-500'); els.badgeGradeNumber.classList.add('bg-[#143c6c]', 'text-white', 'shadow-md');
            els.badgeGradeStatus.textContent = "Seleccionar"; els.badgeGradeStatus.className = "bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded border border-yellow-200 uppercase tracking-wide animate-pulse";

            els.card.classList.add('hidden'); els.initialState.classList.remove('hidden');
            renderCourses();
        }

        function renderCourses() {
            if (!els.courseList) return;
            els.courseList.innerHTML = '';
            // app.py devuelve los kits anidados en la propiedad 'kits'
            const kits = currentSchool.kits; 
            
            if (!kits || kits.length === 0) {
                els.courseList.innerHTML = '<div class="p-6 text-gray-400 text-center text-sm font-instrument">No hay grados registrados.</div>';
                return;
            }

            kits.forEach(kit => {
                const div = document.createElement('div');
                div.className = 'p-4 hover:bg-blue-50 cursor-pointer border-b border-gray-50 last:border-0 font-bold text-gray-600 hover:text-[#143c6c] transition font-outfit flex items-center gap-3 group';
                // La DB devuelve 'grade_name', no kit_name
                div.innerHTML = `<div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center group-hover:bg-[#143c6c] group-hover:text-white transition-colors shrink-0"><i class="fas fa-graduation-cap text-sm"></i></div>${kit.grade_name}`;
                div.onclick = (e) => { e.stopPropagation(); selectCourse(kit); };
                els.courseList.appendChild(div);
            });
        }

        function selectCourse(kit) {
            // CORREGIDO: grade_name
            els.courseBtn.innerHTML = `<span class="font-bold text-[#143c6c] text-base md:text-lg flex items-center gap-2 md:gap-3 truncate"><i class="fas fa-graduation-cap"></i> ${kit.grade_name}</span><div class="bg-green-100 text-green-600 rounded-full p-1 shadow-sm shrink-0"><i class="fas fa-check text-xs"></i></div>`;
            els.courseBtn.className = "w-full bg-blue-50/50 border-2 border-[#143c6c] text-left py-4 px-4 md:py-5 md:px-6 rounded-xl md:rounded-2xl flex items-center justify-between shadow-md transition-all relative z-20";
            els.courseMenu.classList.add('hidden');
            
            els.badgeGradeStatus.textContent = "Completado";
            els.badgeGradeStatus.className = "bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded border border-green-200 uppercase tracking-wide";

            els.initialState.classList.add('hidden'); els.card.classList.add('hidden');
            els.loading.classList.remove('hidden'); els.loading.classList.add('flex');

            setTimeout(() => {
                els.loading.classList.add('hidden'); els.loading.classList.remove('flex');
                showCard(kit);
            }, 500);
        }

        function showCard(kit) {
            if (els.cardColegio) els.cardColegio.textContent = currentSchool.name;
            if (els.cardCity) els.cardCity.textContent = currentSchool.city;
            
            // CORREGIDO: Usar propiedades reales de la DB
            if (els.cardCurso) els.cardCurso.textContent = kit.grade_name;
            if (els.cardImagen) els.cardImagen.src = currentSchool.logo_url;
            
            // El 'kit_name' no existe en la tabla school_kits, usamos grade_name
            if (els.cardKitName) els.cardKitName.textContent = "Kit: " + kit.grade_name;
            if (els.packageDetails) els.packageDetails.textContent = `Contiene ${kit.book_count || 0} libros y materiales requeridos.`;
            
            if (els.addBtn) {
                els.addBtn.onclick = () => {
                    if (window.addToCart) {
                        window.addToCart({
                            id: kit.id,
                            name: `Kit ${kit.grade_name} - ${currentSchool.name}`,
                            price: kit.price,
                            img: currentSchool.logo_url, // Corregido
                            qty: 1
                        });
                    } else {
                        alert("Función agregar al carrito pendiente de integración global.");
                    }
                };
            }

            els.card.classList.remove('hidden');
            const yOffset = -80; 
            const y = els.card.getBoundingClientRect().top + window.pageYOffset + yOffset;
            window.scrollTo({top: y, behavior: 'smooth'});
        }

        // Event Listeners
        if (els.schoolBtn) {
            els.schoolBtn.onclick = (e) => { e.stopPropagation(); els.schoolMenu.classList.toggle('hidden'); els.courseMenu.classList.add('hidden'); if(!els.schoolMenu.classList.contains('hidden')) setTimeout(() => els.schoolSearch.focus(), 100); };
            els.courseBtn.onclick = (e) => { e.stopPropagation(); if (!els.courseBtn.classList.contains('cursor-not-allowed')) { els.courseMenu.classList.toggle('hidden'); els.schoolMenu.classList.add('hidden'); } };
            els.schoolSearch.onclick = (e) => e.stopPropagation();
            els.schoolSearch.onkeyup = (e) => renderSchools(e.target.value);
            document.addEventListener('click', () => { if(els.schoolMenu) els.schoolMenu.classList.add('hidden'); if(els.courseMenu) els.courseMenu.classList.add('hidden'); });
            
            // INICIALIZAR CARGA
            loadSchoolsFromDB();
        }
    })();
</script>